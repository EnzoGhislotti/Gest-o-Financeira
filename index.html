<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíé Finance Pro - Gest√£o Financeira Completa</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíé</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #8B5CF6;
            --primary-dark: #7C3AED;
            --primary-light: #A78BFA;
            --secondary: #EC4899;
            --accent: #06B6D4;
            
            --bg-primary: #0F0F23;
            --bg-secondary: #1A1A2E;
            --bg-tertiary: #16213E;
            --bg-card: #1E1E3F;
            
            --text-primary: #F3F4F6;
            --text-secondary: #9CA3AF;
            --text-muted: #6B7280;
            
            --success: #10B981;
            --success-light: rgba(16, 185, 129, 0.1);
            --warning: #F59E0B;
            --warning-light: rgba(245, 158, 11, 0.1);
            --danger: #EF4444;
            --danger-light: rgba(239, 68, 68, 0.1);
            --info: #3B82F6;
            
            --border: #2D2D4A;
            --shadow: rgba(139, 92, 246, 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .logo {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-icon {
            font-size: 1.8rem;
        }

        .logo p {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .nav {
            flex: 1;
            padding: 1.5rem 0;
        }

        .nav-item {
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: rgba(139, 92, 246, 0.1);
            color: var(--primary-light);
        }

        .nav-item.active {
            background: rgba(139, 92, 246, 0.15);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .nav-icon {
            font-size: 1.25rem;
        }

        .user-section {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .user-details {
            flex: 1;
            overflow: hidden;
        }

        .user-name {
            font-size: 0.875rem;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-email {
            font-size: 0.75rem;
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .sync-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: var(--success-light);
            color: var(--success);
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .btn-logout {
            width: 100%;
            padding: 0.65rem;
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            max-width: 1600px;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-light), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-change {
            font-size: 0.875rem;
            margin-top: 0.5rem;
            color: var(--text-muted);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--shadow);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .form-checkbox input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Pages */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Card Items */
        .credit-card-item, .installment-item, .budget-item, .goal-item, .loan-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
        }

        .credit-card-item::before, .installment-item::before, .loan-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s;
        }

        .installment-dots {
            display: flex;
            gap: 0.35rem;
            margin: 0.75rem 0;
            flex-wrap: wrap;
        }

        .installment-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--border);
        }

        .installment-dot.paid {
            background: var(--success);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.25rem;
        }

        .installment-table {
            width: 100%;
            border-collapse: collapse;
        }

        .installment-table th {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 2px solid var(--border);
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .installment-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-badge.paid {
            background: var(--success-light);
            color: var(--success);
        }

        .status-badge.pending {
            background: var(--warning-light);
            color: var(--warning);
        }

        /* Transaction Item */
        .transaction-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }

        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .transaction-icon.income {
            background: var(--success-light);
            color: var(--success);
        }

        .transaction-icon.expense {
            background: var(--danger-light);
            color: var(--danger);
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .transaction-meta {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .transaction-amount {
            font-size: 1.125rem;
            font-weight: 700;
        }

        .transaction-amount.income {
            color: var(--success);
        }

        .transaction-amount.expense {
            color: var(--danger);
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="setup-screen" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 2rem;">
        <div class="card" style="max-width: 500px; width: 100%;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">üíé</div>
                <h1 class="page-title" style="justify-content: center;">Finance Pro</h1>
                <p class="page-subtitle">Gest√£o financeira moderna e inteligente</p>
            </div>
            
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="setup-email" class="form-input" placeholder="seu@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">Senha (m√≠nimo 6 caracteres)</label>
                <input type="password" id="setup-password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6">
            </div>
            
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 0.75rem;" onclick="login()">
                Entrar
            </button>
            <button class="btn btn-secondary" style="width: 100%; margin-bottom: 1.5rem;" onclick="register()">
                Criar Conta
            </button>
            
            <div style="text-align: center;">
                <button class="btn btn-secondary" onclick="loginWithGoogle()">
                    <span>üîê</span>
                    Entrar com Google
                </button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="app-container" style="display: none;">
        <aside class="sidebar">
            <div class="logo">
                <h1><span class="logo-icon">üíé</span>Finance Pro</h1>
                <p>Gest√£o financeira moderna</p>
            </div>

            <nav class="nav">
                <div class="nav-item active" onclick="showPage('dashboard')">
                    <span class="nav-icon">üìä</span><span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="showPage('cards')">
                    <span class="nav-icon">üí≥</span><span>Meus Cart√µes</span>
                </div>
                <div class="nav-item" onclick="showPage('installments')">
                    <span class="nav-icon">üì±</span><span>Minhas Parcelas</span>
                </div>
                <div class="nav-item" onclick="showPage('loans')">
                    <span class="nav-icon">üí∞</span><span>Empr√©stimos</span>
                </div>
                <div class="nav-item" onclick="showPage('budget')">
                    <span class="nav-icon">üìä</span><span>Or√ßamentos</span>
                </div>
                <div class="nav-item" onclick="showPage('transactions')">
                    <span class="nav-icon">üí∏</span><span>Transa√ß√µes</span>
                </div>
                <div class="nav-item" onclick="showPage('planning')">
                    <span class="nav-icon">üéØ</span><span>Planejamento</span>
                </div>
                <div class="nav-item" onclick="showPage('insights')">
                    <span class="nav-icon">üß†</span><span>Insights</span>
                </div>
            </nav>

            <div class="user-section">
                <div class="sync-badge"><span>‚úì</span><span>Sincronizado</span></div>
                <div class="user-info">
                    <div class="user-avatar">üë§</div>
                    <div class="user-details">
                        <div class="user-name" id="user-name">Usu√°rio</div>
                        <div class="user-email" id="user-email">usuario@email.com</div>
                    </div>
                </div>
                <button class="btn-logout" onclick="logout()">Sair</button>
            </div>
        </aside>

        <main class="main-content">
            <!-- Dashboard -->
            <div id="dashboard" class="page active">
                <div class="page-header">
                    <h1 class="page-title"><span>üìä</span>Vis√£o Geral</h1>
                    <p class="page-subtitle">Seu resumo financeiro completo</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Saldo Dispon√≠vel</div>
                        <div class="stat-value" id="manual-balance">R$ 0,00</div>
                        <div class="stat-change">
                            <button class="btn btn-sm btn-primary" onclick="updateManualBalance()" style="margin-top: 0.5rem;">
                                Atualizar Saldo
                            </button>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Receitas do M√™s</div>
                        <div class="stat-value" id="total-income">R$ 0,00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Despesas do M√™s</div>
                        <div class="stat-value" id="total-expenses">R$ 0,00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Parcelas Ativas</div>
                        <div class="stat-value" id="active-installments-count">0</div>
                        <div class="stat-change" id="installments-monthly">R$ 0/m√™s</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title"><span>üí≥</span>Gastos por Forma de Pagamento</h2>
                        </div>
                        <div id="payment-method-breakdown"></div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title"><span>üè¶</span>Gastos por Banco</h2>
                        </div>
                        <div id="bank-breakdown"></div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem;">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title"><span>üì±</span>Parcelas Ativas</h2>
                        </div>
                        <div id="dashboard-installments-preview"></div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title"><span>üí∞</span>Empr√©stimos Ativos</h2>
                        </div>
                        <div id="dashboard-loans-preview"></div>
                    </div>
                </div>
            </div>

            <!-- Cards Page -->
            <div id="cards" class="page">
                <div class="page-header">
                    <h1 class="page-title"><span>üí≥</span>Meus Cart√µes</h1>
                    <p class="page-subtitle">Gerencie seus cart√µes</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Adicionar Cart√£o</h2>
                    </div>
                    <form id="card-form" onsubmit="addCard(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Nome</label>
                                <input type="text" id="card-name" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Limite Cr√©dito (R$)</label>
                                <input type="number" id="card-limit" class="form-input" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Saldo D√©bito (R$)</label>
                                <input type="number" id="card-balance" class="form-input" step="0.01" value="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Bandeira</label>
                                <select id="card-brand" class="form-select">
                                    <option>Visa</option>
                                    <option>Mastercard</option>
                                    <option>Elo</option>
                                    <option>American Express</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">+ Adicionar</button>
                    </form>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Seus Cart√µes</h2>
                    </div>
                    <div id="cards-list"></div>
                </div>
            </div>

            <!-- Installments Page -->
            <div id="installments" class="page">
                <div class="page-header">
                    <h1 class="page-title"><span>üì±</span>Minhas Parcelas</h1>
                    <p class="page-subtitle">Compras parceladas</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Compras Ativas</div>
                        <div class="stat-value" id="inst-active">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Parcelas Pendentes</div>
                        <div class="stat-value" id="inst-pending">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Valor Mensal</div>
                        <div class="stat-value" id="inst-monthly">R$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Comprometimento</div>
                        <div class="stat-value" id="inst-commitment">0%</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Suas Parcelas</h2>
                    </div>
                    <div id="installments-list"></div>
                </div>
            </div>

            <!-- Loans Page -->
            <div id="loans" class="page">
                <div class="page-header">
                    <h1 class="page-title"><span>üí∞</span>Empr√©stimos</h1>
                    <p class="page-subtitle">Gerencie seus empr√©stimos</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Novo Empr√©stimo</h2>
                    </div>
                    <form id="loan-form" onsubmit="addLoan(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Descri√ß√£o</label>
                                <input type="text" id="loan-desc" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Institui√ß√£o</label>
                                <input type="text" id="loan-institution" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Valor Total (R$)</label>
                                <input type="number" id="loan-amount" class="form-input" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Parcelas</label>
                                <input type="number" id="loan-installments" class="form-input" min="1" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">1¬™ Parcela</label>
                                <input type="date" id="loan-date" class="form-input" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">+ Adicionar Empr√©stimo</button>
                    </form>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Seus Empr√©stimos</h2>
                    </div>
                    <div id="loans-list"></div>
                </div>
            </div>

            <!-- Budget, Transactions, Planning, Insights pages... -->
            <!-- (Keeping existing structure but streamlining for space) -->
            
            <div id="budget" class="page">
                <div class="page-header">
                    <h1 class="page-title"><span>üìä</span>Or√ßamentos</h1>
                </div>
                <div class="card">
                    <p>Or√ßamentos em desenvolvimento...</p>
                </div>
            </div>

            <div id="transactions" class="page">
                <div class="page-header">
                    <h1 class="page-title"><span>üí∏</span>Transa√ß√µes</h1>
                </div>
                <div class="card">
                    <p>Transa√ß√µes em desenvolvimento...</p>
                </div>
            </div>

            <div id="planning" class="page">
                <div class="page-header">
                    <h1 class="page-title"><span>üéØ</span>Planejamento</h1>
                </div>
                <div class="card">
                    <p>Planejamento em desenvolvimento...</p>
                </div>
            </div>

            <div id="insights" class="page">
                <div class="page-header">
                    <h1 class="page-title"><span>üß†</span>Insights</h1>
                </div>
                <div class="card">
                    <p>Insights em desenvolvimento...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Installment Details Modal -->
    <div id="installment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Detalhes</h2>
                <button class="modal-close" onclick="closeInstallmentModal()">√ó</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
  apiKey: "AIzaSyDIaCERQG7n5LY4RmvBvbUns5CcnyjO1Lw",
  authDomain: "financas-5c7b4.firebaseapp.com",
  databaseURL: "https://financas-5c7b4-default-rtdb.firebaseio.com",
  projectId: "financas-5c7b4",
  storageBucket: "financas-5c7b4.firebasestorage.app",
  messagingSenderId: "598951471840",
  appId: "1:598951471840:web:a2d70757f28d8ee9edfe85"
};

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentUser = null;
        let cards = [];
        let transactions = [];
        let loans = [];
        let manualBalance = 0;

        // Auth
        function login() {
            const email = document.getElementById('setup-email').value.trim();
            const password = document.getElementById('setup-password').value;
            
            if (!email || !password) {
                alert('Preencha email e senha');
                return;
            }
            
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => alert('Erro: ' + error.message));
        }

        function register() {
            const email = document.getElementById('setup-email').value.trim();
            const password = document.getElementById('setup-password').value;
            
            if (!email || !password) {
                alert('Preencha email e senha');
                return;
            }
            
            if (password.length < 6) {
                alert('Senha deve ter no m√≠nimo 6 caracteres');
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then(() => alert('Conta criada!'))
                .catch(error => alert('Erro: ' + error.message));
        }

        function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .catch(error => alert('Erro: ' + error.message));
        }

        function logout() {
            auth.signOut();
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('setup-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                document.getElementById('user-name').textContent = user.displayName || 'Usu√°rio';
                document.getElementById('user-email').textContent = user.email;
                loadUserData();
            } else {
                currentUser = null;
                document.getElementById('setup-screen').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
            }
        });

        function loadUserData() {
            const userId = currentUser.uid;
            
            database.ref(`users/${userId}/manualBalance`).on('value', snapshot => {
                manualBalance = snapshot.val() || 0;
                updateDashboard();
            });

            database.ref(`users/${userId}/cards`).on('value', snapshot => {
                cards = [];
                snapshot.forEach(child => {
                    cards.push({ id: child.key, ...child.val() });
                });
                renderCards();
                updateDashboard();
            });

            database.ref(`users/${userId}/transactions`).on('value', snapshot => {
                transactions = [];
                snapshot.forEach(child => {
                    transactions.push({ id: child.key, ...child.val() });
                });
                renderInstallments();
                updateDashboard();
            });

            database.ref(`users/${userId}/loans`).on('value', snapshot => {
                loans = [];
                snapshot.forEach(child => {
                    loans.push({ id: child.key, ...child.val() });
                });
                renderLoans();
                updateDashboard();
            });
        }

        // Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');
        }

        // Utils
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        function formatDate(dateString) {
            return new Date(dateString + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        // Manual Balance
        function updateManualBalance() {
            const newBalance = prompt('Digite o saldo dispon√≠vel:', manualBalance);
            if (newBalance !== null && !isNaN(newBalance)) {
                database.ref(`users/${currentUser.uid}/manualBalance`).set(parseFloat(newBalance));
            }
        }

        // Cards
        function addCard(e) {
            e.preventDefault();
            const card = {
                name: document.getElementById('card-name').value,
                limit: parseFloat(document.getElementById('card-limit').value),
                balance: parseFloat(document.getElementById('card-balance').value),
                brand: document.getElementById('card-brand').value,
                used: 0
            };
            database.ref(`users/${currentUser.uid}/cards`).push(card);
            document.getElementById('card-form').reset();
        }

        function renderCards() {
            const list = document.getElementById('cards-list');
            if (cards.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí≥</div><p>Nenhum cart√£o</p></div>';
                return;
            }
            list.innerHTML = cards.map(card => {
                const usedPct = (card.used / card.limit * 100).toFixed(1);
                return `
                    <div class="credit-card-item">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <div>
                                <div style="font-size: 1.25rem; font-weight: 700;">${card.name}</div>
                                <div style="color: var(--text-muted);">${card.brand}</div>
                            </div>
                        </div>
                        <div style="margin: 1rem 0;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 0.5rem;">
                                <span>Cr√©dito: ${formatCurrency(card.limit - card.used)} dispon√≠vel</span>
                                <span>${usedPct}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${usedPct}%"></div>
                            </div>
                            <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-muted);">
                                Limite: ${formatCurrency(card.limit)}
                            </div>
                        </div>
                        <div style="padding-top: 1rem; border-top: 1px solid var(--border);">
                            <div style="font-size: 0.875rem; color: var(--text-muted);">D√©bito/Pix</div>
                            <div style="font-size: 1.125rem; font-weight: 700;">${formatCurrency(card.balance)}</div>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="deleteCard('${card.id}')" style="margin-top: 1rem;">üóëÔ∏è Excluir</button>
                    </div>
                `;
            }).join('');
        }

        function deleteCard(id) {
            if (confirm('Excluir cart√£o?')) {
                database.ref(`users/${currentUser.uid}/cards/${id}`).remove();
            }
        }

        // Installments
        function renderInstallments() {
            const groups = {};
            transactions.filter(t => t.isInstallment).forEach(t => {
                if (!groups[t.installmentParentId]) groups[t.installmentParentId] = [];
                groups[t.installmentParentId].push(t);
            });

            const today = new Date();
            const active = Object.values(groups).filter(g => g.some(t => new Date(t.date) >= today));

            const totalPending = active.reduce((sum, g) => sum + g.filter(t => new Date(t.date) >= today).length, 0);
            const monthlyTotal = active.reduce((sum, g) => sum + g[0].amount, 0);

            document.getElementById('inst-active').textContent = active.length;
            document.getElementById('inst-pending').textContent = totalPending;
            document.getElementById('inst-monthly').textContent = formatCurrency(monthlyTotal);

            const currentMonth = new Date().toISOString().substring(0, 7);
            const income = transactions.filter(t => t.type === 'income' && t.date.startsWith(currentMonth)).reduce((s, t) => s + t.amount, 0);
            const commitment = income > 0 ? ((monthlyTotal / income) * 100).toFixed(1) : 0;
            document.getElementById('inst-commitment').textContent = commitment + '%';

            const list = document.getElementById('installments-list');
            if (active.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì±</div><p>Nenhuma parcela ativa</p></div>';
                return;
            }

            list.innerHTML = active.map(group => {
                const sorted = group.sort((a, b) => a.installmentNumber - b.installmentNumber);
                const first = sorted[0];
                const paid = sorted.filter(t => new Date(t.date) < today).length;
                const pct = (paid / first.installmentTotal * 100).toFixed(0);
                const remaining = first.installmentTotal - paid;
                const next = sorted.find(t => new Date(t.date) >= today);

                return `
                    <div class="installment-item">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <div>
                                <div style="font-size: 1.125rem; font-weight: 700;">${first.description}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.25rem; font-weight: 700; color: var(--danger);">${formatCurrency(first.amount)}<span style="font-size: 0.875rem;">/m√™s</span></div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Total: ${formatCurrency(first.installmentOriginalAmount)}</div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 0.5rem;">
                                <span>Paga ${paid}/${first.installmentTotal} parcelas</span>
                                <span>${pct}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${pct}%"></div>
                            </div>
                            <div class="installment-dots">
                                ${Array.from({length: first.installmentTotal}, (_, i) => 
                                    `<div class="installment-dot ${i < paid ? 'paid' : ''}"></div>`
                                ).join('')}
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 0.75rem; font-size: 0.875rem;">
                            <span style="color: var(--text-muted);">Faltam ${formatCurrency(remaining * first.amount)}</span>
                            ${next ? `<span style="color: var(--primary); font-weight: 600;">Pr√≥xima: ${formatDate(next.date)}</span>` : ''}
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-sm btn-secondary" onclick="viewInstallmentDetails(${first.installmentParentId})">Ver Detalhes</button>
                            <button class="btn btn-sm btn-success" onclick="payOffInstallment(${first.installmentParentId})">Quitar Todas</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteAllInstallments(${first.installmentParentId})">Excluir Todas</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewInstallmentDetails(parentId) {
            const group = transactions.filter(t => t.installmentParentId === parentId);
            if (!group.length) return;

            const sorted = group.sort((a, b) => a.installmentNumber - b.installmentNumber);
            const today = new Date();

            document.getElementById('modal-title').textContent = sorted[0].description;
            document.getElementById('modal-body').innerHTML = `
                <table class="installment-table">
                    <thead>
                        <tr>
                            <th>Parcela</th>
                            <th>Vencimento</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sorted.map(t => {
                            const isPaid = new Date(t.date) < today;
                            return `
                                <tr id="inst-row-${t.id}">
                                    <td><strong>${t.installmentNumber}/${t.installmentTotal}</strong></td>
                                    <td>${formatDate(t.date)}</td>
                                    <td><strong>${formatCurrency(t.amount)}</strong></td>
                                    <td><span class="status-badge ${isPaid ? 'paid' : 'pending'}" id="status-${t.id}">${isPaid ? '‚úì Paga' : 'Pendente'}</span></td>
                                    <td>
                                        ${!isPaid ? `<button class="btn btn-sm btn-success" onclick="markAsPaid('${t.id}', ${parentId})">Marcar como Paga</button>` : 
                                        `<button class="btn btn-sm btn-secondary" onclick="markAsPending('${t.id}', ${parentId})">Desfazer</button>`}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('installment-modal').classList.add('active');
        }

        function closeInstallmentModal() {
            document.getElementById('installment-modal').classList.remove('active');
            renderInstallments();
        }

        function markAsPaid(id, parentId) {
            const t = transactions.find(x => x.id === id);
            if (!t) return;
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            database.ref(`users/${currentUser.uid}/transactions/${id}/date`).set(yesterday.toISOString().split('T')[0]);
        }

        function markAsPending(id, parentId) {
            const t = transactions.find(x => x.id === id);
            if (!t) return;
            const group = transactions.filter(x => x.installmentParentId === parentId);
            const sorted = group.sort((a, b) => a.installmentNumber - b.installmentNumber);
            const first = sorted[0];
            const firstDate = new Date(first.date);
            const monthsToAdd = t.installmentNumber - first.installmentNumber;
            const originalDate = new Date(firstDate);
            originalDate.setMonth(originalDate.getMonth() + monthsToAdd);
            database.ref(`users/${currentUser.uid}/transactions/${id}/date`).set(originalDate.toISOString().split('T')[0]);
        }

        function payOffInstallment(parentId) {
            const group = transactions.filter(t => t.installmentParentId === parentId);
            const today = new Date();
            const remaining = group.filter(t => new Date(t.date) >= today);
            if (confirm(`Quitar ${remaining.length} parcelas?`)) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                remaining.forEach(t => {
                    database.ref(`users/${currentUser.uid}/transactions/${t.id}/date`).set(yesterday.toISOString().split('T')[0]);
                });
            }
        }

        function deleteAllInstallments(parentId) {
            if (confirm('Excluir TODAS as parcelas?')) {
                transactions.filter(t => t.installmentParentId === parentId).forEach(t => {
                    database.ref(`users/${currentUser.uid}/transactions/${t.id}`).remove();
                });
            }
        }

        // Loans
        function addLoan(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('loan-amount').value);
            const installments = parseInt(document.getElementById('loan-installments').value);
            const monthlyAmount = amount / installments;
            const firstDate = new Date(document.getElementById('loan-date').value);
            const parentId = Date.now();

            for (let i = 0; i < installments; i++) {
                const date = new Date(firstDate);
                date.setMonth(date.getMonth() + i);
                const loan = {
                    description: document.getElementById('loan-desc').value,
                    institution: document.getElementById('loan-institution').value,
                    amount: monthlyAmount,
                    date: date.toISOString().split('T')[0],
                    isLoan: true,
                    loanNumber: i + 1,
                    loanTotal: installments,
                    loanParentId: parentId,
                    loanOriginalAmount: amount
                };
                database.ref(`users/${currentUser.uid}/loans`).push(loan);
            }
            document.getElementById('loan-form').reset();
        }

        function renderLoans() {
            const groups = {};
            loans.forEach(l => {
                if (!groups[l.loanParentId]) groups[l.loanParentId] = [];
                groups[l.loanParentId].push(l);
            });

            const today = new Date();
            const active = Object.values(groups).filter(g => g.some(l => new Date(l.date) >= today));

            const list = document.getElementById('loans-list');
            if (active.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí∞</div><p>Nenhum empr√©stimo</p></div>';
                return;
            }

            list.innerHTML = active.map(group => {
                const sorted = group.sort((a, b) => a.loanNumber - b.loanNumber);
                const first = sorted[0];
                const paid = sorted.filter(l => new Date(l.date) < today).length;
                const pct = (paid / first.loanTotal * 100).toFixed(0);

                return `
                    <div class="loan-item">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <div>
                                <div style="font-size: 1.125rem; font-weight: 700;">${first.description}</div>
                                <div style="font-size: 0.875rem; color: var(--text-muted);">${first.institution}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.25rem; font-weight: 700; color: var(--danger);">${formatCurrency(first.amount)}<span style="font-size: 0.875rem;">/m√™s</span></div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Total: ${formatCurrency(first.loanOriginalAmount)}</div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 0.5rem;">
                                <span>Paga ${paid}/${first.loanTotal} parcelas</span>
                                <span>${pct}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${pct}%"></div>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="deleteLoan(${first.loanParentId})" style="margin-top: 1rem;">üóëÔ∏è Excluir</button>
                    </div>
                `;
            }).join('');
        }

        function deleteLoan(parentId) {
            if (confirm('Excluir este empr√©stimo?')) {
                loans.filter(l => l.loanParentId === parentId).forEach(l => {
                    database.ref(`users/${currentUser.uid}/loans/${l.id}`).remove();
                });
            }
        }

        // Dashboard
        function updateDashboard() {
            document.getElementById('manual-balance').textContent = formatCurrency(manualBalance);

            const currentMonth = new Date().toISOString().substring(0, 7);
            const income = transactions.filter(t => t.type === 'income' && t.date.startsWith(currentMonth)).reduce((s, t) => s + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense' && t.date.startsWith(currentMonth)).reduce((s, t) => s + t.amount, 0);

            document.getElementById('total-income').textContent = formatCurrency(income);
            document.getElementById('total-expenses').textContent = formatCurrency(expenses);

            // Installments count
            const instGroups = {};
            transactions.filter(t => t.isInstallment).forEach(t => {
                if (!instGroups[t.installmentParentId]) instGroups[t.installmentParentId] = [];
                instGroups[t.installmentParentId].push(t);
            });
            const today = new Date();
            const activeInst = Object.values(instGroups).filter(g => g.some(t => new Date(t.date) >= today));
            const monthlyInst = activeInst.reduce((sum, g) => sum + g[0].amount, 0);
            document.getElementById('active-installments-count').textContent = activeInst.length;
            document.getElementById('installments-monthly').textContent = formatCurrency(monthlyInst) + '/m√™s';

            // Payment method breakdown
            const pmBreakdown = {};
            transactions.filter(t => t.type === 'expense' && t.date.startsWith(currentMonth) && t.paymentMethod).forEach(t => {
                pmBreakdown[t.paymentMethod] = (pmBreakdown[t.paymentMethod] || 0) + t.amount;
            });
            const pmEl = document.getElementById('payment-method-breakdown');
            if (Object.keys(pmBreakdown).length === 0) {
                pmEl.innerHTML = '<div class="empty-state"><p style="font-size: 0.9rem;">Sem dados</p></div>';
            } else {
                pmEl.innerHTML = Object.entries(pmBreakdown).sort((a, b) => b[1] - a[1]).map(([method, amount]) => `
                    <div style="padding: 0.75rem; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>${method}</span>
                            <span style="font-weight: 700;">${formatCurrency(amount)}</span>
                        </div>
                    </div>
                `).join('');
            }

            // Bank breakdown
            const bankBreakdown = {};
            transactions.filter(t => t.type === 'expense' && t.date.startsWith(currentMonth) && t.card).forEach(t => {
                const card = cards.find(c => c.id === t.card);
                if (card) {
                    bankBreakdown[card.name] = (bankBreakdown[card.name] || 0) + t.amount;
                }
            });
            const bankEl = document.getElementById('bank-breakdown');
            if (Object.keys(bankBreakdown).length === 0) {
                bankEl.innerHTML = '<div class="empty-state"><p style="font-size: 0.9rem;">Sem dados</p></div>';
            } else {
                bankEl.innerHTML = Object.entries(bankBreakdown).sort((a, b) => b[1] - a[1]).map(([bank, amount]) => `
                    <div style="padding: 0.75rem; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>${bank}</span>
                            <span style="font-weight: 700;">${formatCurrency(amount)}</span>
                        </div>
                    </div>
                `).join('');
            }

            // Installments preview
            const instPreview = document.getElementById('dashboard-installments-preview');
            if (activeInst.length === 0) {
                instPreview.innerHTML = '<div class="empty-state"><p style="font-size: 0.9rem;">Nenhuma parcela ativa</p></div>';
            } else {
                instPreview.innerHTML = activeInst.slice(0, 3).map(group => {
                    const sorted = group.sort((a, b) => a.installmentNumber - b.installmentNumber);
                    const first = sorted[0];
                    const paid = sorted.filter(t => new Date(t.date) < today).length;
                    return `
                        <div style="padding: 0.75rem; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <div>
                                    <div style="font-weight: 600;">${first.description}</div>
                                    <div style="font-size: 0.875rem; color: var(--text-muted);">${paid}/${first.installmentTotal} pagas</div>
                                </div>
                                <div style="font-weight: 700; color: var(--danger);">${formatCurrency(first.amount)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Loans preview
            const loanGroups = {};
            loans.forEach(l => {
                if (!loanGroups[l.loanParentId]) loanGroups[l.loanParentId] = [];
                loanGroups[l.loanParentId].push(l);
            });
            const activeLoans = Object.values(loanGroups).filter(g => g.some(l => new Date(l.date) >= today));
            const loansPreview = document.getElementById('dashboard-loans-preview');
            if (activeLoans.length === 0) {
                loansPreview.innerHTML = '<div class="empty-state"><p style="font-size: 0.9rem;">Nenhum empr√©stimo ativo</p></div>';
            } else {
                loansPreview.innerHTML = activeLoans.slice(0, 3).map(group => {
                    const sorted = group.sort((a, b) => a.loanNumber - b.loanNumber);
                    const first = sorted[0];
                    const paid = sorted.filter(l => new Date(l.date) < today).length;
                    return `
                        <div style="padding: 0.75rem; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <div>
                                    <div style="font-weight: 600;">${first.description}</div>
                                    <div style="font-size: 0.875rem; color: var(--text-muted);">${paid}/${first.loanTotal} pagas</div>
                                </div>
                                <div style="font-weight: 700; color: var(--danger);">${formatCurrency(first.amount)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
    </script>
</body>
</html>
